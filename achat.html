<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Achat – Produits en ligne</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family:Arial; 
  background:#f2f7f4; 
  padding:20px; 
  margin:0;
  overflow-x: hidden; /* Bloque le scroll horizontal */
}

.topbar {
  display:flex; flex-direction:column; align-items:flex-start;
  background:#2e8b57; color:white; padding:20px; border-radius:8px; margin-bottom:20px;
}
.topbar span { font-weight:bold; font-size:1.2em; margin-bottom:10px; }
.topbar button { border:none; padding:8px 14px; border-radius:6px; cursor:pointer; color:white; font-weight:bold; }
.logout { background:#c0392b; }
.logout:hover { background:#e74c3c; }
.messages-btn { background:#2980b9; margin-top:5px; position:relative; }
.messages-btn:hover { background:#3498db; }
.messages-btn span { 
  position:absolute; top:-5px; right:-5px; 
  background:red; color:white; border-radius:50%; 
  padding:2px 6px; font-size:0.75em; font-weight:bold; display:none;
}

.container {
  max-width:900px;
  margin:auto;
  display:flex;
  flex-direction:column;
  gap:15px;
  position: relative;
  z-index:1;
  overflow-y: auto; /* Scroll vertical seulement */
  height: calc(100vh - 120px); /* Ajuste pour topbar et padding */
}

.product { background:white; padding:15px; border-radius:8px; display:flex; gap:15px; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
.product img { width:120px; height:120px; object-fit:cover; border-radius:8px; }
.product-info { flex:1; }
.product-info strong { font-size:1.1em; }
.product button { background:#2e8b57; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:bold; }
.product button:hover { background:#27ae60; }

/* CHAT */
.chat-container { 
  position:fixed; top:0; left:0; width:300px; height:100%; 
  background:white; border-right:3px solid #2e8b57; 
  box-shadow:4px 0 10px rgba(0,0,0,0.2); 
  display:flex; flex-direction:column; transform:translateX(-100%); transition:0.3s ease; z-index:1000;
  overscroll-behavior: contain; /* Bloque propagation scroll */
}
.chat-container.open { transform:translateX(0); }
.chat-container h4 { margin:0; padding:15px; text-align:center; background:#2e8b57; color:white; }
.messages-list { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:10px; }
.message { padding:10px 15px; border-radius:18px; max-width:75%; font-size:0.95em; word-wrap:break-word; }
.message.from { background:#ecf0f1; color:#333; align-self:flex-start; }
.message.to { background:#2e8b57; color:white; align-self:flex-end; }
.input-area { display:flex; gap:10px; padding:10px; border-top:1px solid #ddd; }
.input-area input { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; }
.input-area button { padding:10px 18px; border:none; border-radius:8px; background:#2e8b57; color:white; font-weight:bold; cursor:pointer; }
.input-area button:hover { background:#27ae60; }

/* Discussions */
#discussionsPanel { 
  position:fixed; top:0; right:0; width:300px; height:100%; 
  background:white; border-left:3px solid #2e8b57; 
  box-shadow:-4px 0 10px rgba(0,0,0,0.2); 
  display:flex; flex-direction:column; 
  transform:translateX(100%); transition:0.3s ease; z-index:1001; 
  overscroll-behavior: contain; /* Bloque propagation scroll */
}
#discussionsPanel.open { transform:translateX(0); }
#discussionsPanel h4 { margin:0; padding:15px; text-align:center; background:#2e8b57; color:white; }
.discussion-item { padding:10px; border:1px solid #ccc; border-radius:8px; margin:5px 10px; cursor:pointer; background:#f9f9f9; }
.discussion-item:hover { background:#e0f7fa; }
</style>
</head>
<body>

<div class="topbar">
  <span id="userEmail">Connecté :</span>
  <button class="logout" id="logoutBtn">Déconnexion</button>
  <button class="messages-btn" id="messagesBtn">Messages <span id="newMsgBadge">0</span></button>
</div>

<h3>Produits en ligne</h3>
<div class="container" id="productList"></div>

<!-- Chat -->
<div class="chat-container" id="chatContainer">
  <h4 id="chatProductName">Chat</h4>
  <div class="messages-list" id="messagesList"></div>
  <div class="input-area">
    <input type="text" id="messageInput" placeholder="Écrire un message...">
    <button id="sendBtn">Envoyer</button>
  </div>
</div>

<!-- Discussions -->
<div id="discussionsPanel">
  <h4>Mes Discussions</h4>
  <div id="discussionsList"></div>
</div>

<script type="module">
import { supabase } from './supabase.js';

let currentUser;
let activeSellerId = null;
let activeProductId = null;

/* Auth */
const { data:{user} } = await supabase.auth.getUser();
if(!user) location.href='login.html';
currentUser = user;
document.getElementById('userEmail').textContent = "Connecté : " + user.email;

/* Déconnexion */
document.getElementById('logoutBtn').onclick = async ()=>{
  await supabase.auth.signOut();
  location.href='login.html';
};

/* BOUTON MESSAGES */
const badge = document.getElementById('newMsgBadge');
document.getElementById('messagesBtn').onclick = ()=>{
  const panel = document.getElementById('discussionsPanel');
  const chat = document.getElementById('chatContainer');
  chat.classList.remove('open'); // fermer chat
  panel.classList.toggle('open'); // ouvrir / fermer discussions
  badge.style.display = 'none'; // cacher badge
  if(panel.classList.contains('open')) loadDiscussions();
};

/* CHARGER DISCUSSIONS */
async function loadDiscussions(){
  const { data, error } = await supabase
    .from('messages')
    .select('product_id, products(name), from_user')
    .or(`from_user.eq.${currentUser.id},to_user.eq.${currentUser.id}`)
    .order('created_at',{ascending:false});
  if(error) return;

  const box = document.getElementById('discussionsList');
  box.innerHTML = '';
  const unique = {};
  data.forEach(d=>{
    unique[d.product_id] = d;
  });

  Object.values(unique).forEach(d=>{
    const div = document.createElement('div');
    div.className = 'discussion-item';
    div.textContent = d.products.name;
    div.onclick = ()=>{
      openChat(d.from_user, d.product_id, d.products.name);
    };
    box.appendChild(div);
  });
}

/* Charger produits */
async function loadProducts(){
  const { data, error } = await supabase
    .from('products')
    .select('*, profiles(username)')
    .order('created_at',{ascending:false});
  if(error){ alert(error.message); return; }
  const list = document.getElementById('productList');
  list.innerHTML = '';
  data.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'product';
    div.innerHTML = `
      <img src="${p.imageurl}">
      <div class="product-info">
        <strong>${p.name}</strong><br>
        ${p.description}<br>
        Prix : ${p.price} FCFA<br>
        Vendeur : ${p.profiles.username}<br>
        WhatsApp : ${p.whatsapp}<br>
        <button>Contacter</button>
      </div>
    `;
    div.querySelector('button').onclick = ()=>{
      openChat(p.user_id, p.id, p.name);
    };
    list.appendChild(div);
  });
}

/* Chat */
function openChat(sellerId, productId, productName){
  activeSellerId = sellerId;
  activeProductId = productId;
  document.getElementById('chatProductName').textContent =
    "Discussion avec le vendeur — Produit : " + productName;
  document.getElementById('discussionsPanel').classList.remove('open');
  document.getElementById('chatContainer').classList.add('open');
  loadMessages();
}

async function loadMessages(){
  if(!activeProductId) return;
  const { data } = await supabase
    .from('messages')
    .select('*')
    .or(`from_user.eq.${currentUser.id},to_user.eq.${currentUser.id}`)
    .eq('product_id', activeProductId)
    .order('created_at',{ascending:true});
  const box = document.getElementById('messagesList');
  box.innerHTML = '';
  data.forEach(m=>{
    const div = document.createElement('div');
    div.className =
      m.from_user === currentUser.id ? 'message to' : 'message from';
    div.textContent = m.message;
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;

  // Mettre à jour badge nouveau message
  const unread = data.filter(m=>m.to_user===currentUser.id && !m.read).length;
  if(unread>0) badge.textContent = unread;
  badge.style.display = unread>0 ? 'inline' : 'none';
}

/* Envoyer message */
document.getElementById('sendBtn').onclick = async ()=>{
  const text = messageInput.value.trim();
  if(!text) return;
  await supabase.from('messages').insert({
    message: text,
    from_user: currentUser.id,
    to_user: activeSellerId,
    product_id: activeProductId
  });
  messageInput.value = '';
  loadMessages();
};

/* Fermer chat / discussions si clic hors */
document.addEventListener('click', (e)=>{
  const chat = document.getElementById('chatContainer');
  const discussions = document.getElementById('discussionsPanel');
  if(!chat.contains(e.target) && !discussions.contains(e.target) &&
     !e.target.classList.contains('messages-btn') &&
     !e.target.classList.contains('product') &&
     !e.target.closest('.product-info')){
    chat.classList.remove('open');
    discussions.classList.remove('open');
  }
});

/* Bloquer scroll propagation chat */
document.querySelector('.messages-list').addEventListener('wheel', (e)=>{
  e.stopPropagation();
});

setInterval(loadMessages,2000);
loadProducts();
</script>
</body>
</html>