<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Marketplace – Produits et Messages</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family:Arial; background:#f2f7f4; margin:0; padding:20px; }

/* Topbar */
.topbar { display:flex; justify-content:space-between; align-items:center; background:#2e8b57; color:white; padding:20px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1); margin-bottom:20px; }
.topbar span { font-size:1.2em; font-weight:bold; }
.topbar button { border:none; padding:8px 14px; border-radius:6px; cursor:pointer; color:white; font-weight:bold; transition:0.2s; }
.logout { background:#c0392b; }
.logout:hover { background:#e74c3c; }

/* Produits */
.container { max-width:1000px; margin:auto; display:flex; flex-direction:column; gap:20px; }
.add-product, .myProductsContainer { background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
.myProductsList { display:flex; overflow-x:auto; gap:15px; padding:10px 0; }
.myProduct { min-width:220px; background:#fff; padding:10px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); display:flex; flex-direction:column; align-items:center; }
.myProduct img { width:150px; height:150px; object-fit:cover; border-radius:8px; margin-bottom:10px; }
.myProduct-info { text-align:center; margin-bottom:10px; }
.myProduct button { background:#2e8b57; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:bold; transition:0.2s; margin-top:5px; }
.myProduct button.deleteBtn { background:#c0392b; }
.myProduct button.deleteBtn:hover { background:#e74c3c; }
.myProduct button.messageBtn:hover { background:#27ae60; }

/* Input fields */
.input-field { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc; font-size:1em; }
.addBtn { background:#2e8b57; color:white; border:none; padding:10px 15px; border-radius:6px; cursor:pointer; font-weight:bold; transition:0.2s; width:100%; }
.addBtn:hover { background:#27ae60; }

/* Chat latéral */
.chat-container {
  position:fixed; top:0; left:0; width:350px; height:100%; background:white; border-right:2px solid #2e8b57; box-shadow:4px 0 8px rgba(0,0,0,0.2);
  display:flex; flex-direction:column; transform:translateX(-100%); transition:0.3s ease; z-index:1000;
}
.chat-container.open { transform:translateX(0); }
.chat-container h4 { margin:0; padding:15px 0; text-align:center; color:#2e8b57; border-bottom:1px solid #ddd; }
.buyerList { display:flex; flex-direction:column; gap:8px; max-height:120px; overflow-y:auto; padding:0 10px; }
.buyerBtn { padding:8px 12px; border:none; border-radius:6px; background:#34495e; color:white; cursor:pointer; text-align:left; transition:0.2s; font-weight:bold; width:100%; }
.buyerBtn:hover { background:#2c3e50; }
.buyerBtn.active { background:#16a085; }
.messages-list { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:8px; padding:10px; }
.message { padding:10px 15px; border-radius:20px; max-width:75%; word-wrap:break-word; font-size:0.95em; }
.message.from { background:#2ecc71; color:white; align-self:flex-start; }
.message.to { background:#2980b9; color:white; align-self:flex-end; }
.input-area { display:flex; gap:10px; padding:10px; border-top:1px solid #ddd; }
.input-area input { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:1em; }
.input-area button { padding:10px 20px; border:none; border-radius:8px; background:#2e8b57; color:white; cursor:pointer; font-weight:bold; transition:0.2s; }
.input-area button:hover { background:#27ae60; }
</style>
</head>
<body>

<div class="topbar">
  <span id="userEmail">Connecté :</span>
  <button class="logout" id="logoutBtn">Déconnexion</button>
</div>

<h3>Ajouter un produit</h3>
<div class="add-product">
  <input type="text" id="name" class="input-field" placeholder="Nom du produit">
  <textarea id="description" class="input-field" placeholder="Description"></textarea>
  <input type="number" id="price" class="input-field" placeholder="Prix">
  <input type="text" id="whatsapp" class="input-field" placeholder="Numéro WhatsApp">
  <input type="file" id="image" accept="image/*" class="input-field">
  <button id="addBtn" class="addBtn">Ajouter</button>
</div>

<h3>Mes produits en ligne</h3>
<div class="myProductsContainer">
  <div class="myProductsList" id="myProductsList"></div>
</div>

<!-- Chat -->
<div class="chat-container" id="chatContainer">
  <h4 id="chatProductName">Messages</h4>
  <div class="buyerList" id="buyerList"></div>
  <div class="messages-list" id="messagesList"></div>
  <div class="input-area">
    <input type="text" id="messageInput" placeholder="Écrire un message...">
    <button id="sendBtn">Envoyer</button>
  </div>
</div>

<script type="module">
import { supabase } from './js/supabase.js';

let currentUser = null;
let activeBuyerId = null;
let activeProductId = null;

// Vérifier connexion
const { data:{user} } = await supabase.auth.getUser();
if(!user) location.href='login.html';
currentUser = user;
document.getElementById('userEmail').textContent = "Connecté : " + user.email;

// Déconnexion
document.getElementById('logoutBtn').onclick = async ()=>{
  await supabase.auth.signOut();
  location.href='login.html';
}

// Ajouter produit
document.getElementById('addBtn').onclick = async ()=>{
  const name=document.getElementById('name').value.trim();
  const description=document.getElementById('description').value.trim();
  const price=document.getElementById('price').value;
  const whatsapp=document.getElementById('whatsapp').value.trim();
  const file=document.getElementById('image').files[0];
  if(!name || !description || !price || !whatsapp || !file){ alert('Remplis tous les champs'); return; }

  const fileName = `${currentUser.id}_${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
  const { error:uploadError } = await supabase.storage.from('products').upload(fileName,file);
  if(uploadError){ alert(uploadError.message); return; }

  const { data:urlData } = supabase.storage.from('products').getPublicUrl(fileName);
  const { error } = await supabase.from('products').insert([{
    name, description, price, whatsapp,
    imageurl:urlData.publicUrl,
    user_id: currentUser.id
  }]);
  if(error){ alert(error.message); return; }

  alert('Produit ajouté avec succès');
  loadMyProducts();
}

// Charger produits
async function loadMyProducts(){
  const { data, error } = await supabase.from('products').select('*').order('created_at',{ascending:false});
  if(error){ console.error(error); return; }

  const container = document.getElementById('myProductsList');
  container.innerHTML = '';

  data.forEach(p=>{
    const isOwner = p.user_id === currentUser.id;

    const div = document.createElement('div');
    div.className='myProduct';
    div.innerHTML=`
      <img src="${p.imageurl}">
      <div class="myProduct-info">
        <strong>${p.name}</strong><br>
        ${p.description}<br>
        Prix : ${p.price} FCFA<br>
        WhatsApp : ${p.whatsapp}
      </div>
      ${isOwner ? `<button class="deleteBtn">Supprimer</button>` : ''}
      <button class="messageBtn">${isOwner ? 'Messages' : 'Contacter'}</button>
    `;
    container.appendChild(div);

    if(isOwner){
      div.querySelector('.deleteBtn').addEventListener('click', async ()=>{
        if(!confirm('Supprimer ce produit définitivement ?')) return;
        const { error } = await supabase.from('products').delete().eq('id', p.id);
        if(error){ alert(error.message); return; }
        loadMyProducts();
      });
    }

    div.querySelector('.messageBtn').addEventListener('click', ()=>{
      if(isOwner){
        openProductChat(p.id, p.name);
      } else {
        openBuyerChat(p.id, p.user_id, p.name);
      }
    });
  });
}

// Charger acheteurs pour un produit
async function loadBuyers(productId){
  const { data, error } = await supabase
    .from('messages')
    .select('*')
    .eq('to_user', currentUser.id)
    .eq('product_id', productId)
    .order('created_at', {ascending:false});
  if(error){ console.error(error); return; }

  const buyersContainer = document.getElementById('buyerList');
  buyersContainer.innerHTML = '';
  const seen = new Set();
  data.forEach(msg=>{
    if(!seen.has(msg.from_user)){
      seen.add(msg.from_user);
      const btn = document.createElement('button');
      btn.className = 'buyerBtn';
      btn.textContent = msg.from_user;
      btn.addEventListener('click', ()=>openChat(msg.from_user, productId));
      buyersContainer.appendChild(btn);
    }
  });
}

// Vendeur ouvre chat
function openProductChat(productId, productName){
  activeProductId = productId;
  document.getElementById('chatProductName').textContent = `Messages - ${productName}`;
  document.getElementById('chatContainer').classList.add('open');
  document.getElementById('messageInput').value = '';
  loadBuyers(productId);
}

// Acheteur ouvre chat
function openBuyerChat(productId, sellerId, productName){
  activeProductId = productId;
  activeBuyerId = currentUser.id; // L'acheteur est lui-même
  document.getElementById('chatProductName').textContent = `Chat avec vendeur - ${productName}`;
  document.getElementById('chatContainer').classList.add('open');
  document.getElementById('messageInput').value = '';
  loadMessagesSeller(sellerId, productId);
}

// Ouvrir chat avec un acheteur (vendeur)
function openChat(buyerId, productId){
  activeBuyerId = buyerId;
  activeProductId = productId;
  const buttons = document.querySelectorAll('.buyerBtn');
  buttons.forEach(b=>b.classList.remove('active'));
  buttons.forEach(b=>{ if(b.textContent===buyerId) b.classList.add('active'); });
  loadMessages();
}

// Charger messages vendeur
async function loadMessages(){
  if(!activeBuyerId || !activeProductId) return;
  const { data, error } = await supabase
    .from('messages')
    .select('*')
    .eq('product_id', activeProductId)
    .or(`from_user.eq.${activeBuyerId},to_user.eq.${activeBuyerId}`)
    .order('created_at', {ascending:true});
  if(error){ console.error(error); return; }

  const container = document.getElementById('messagesList');
  container.innerHTML = '';
  data.forEach(m=>{
    const div = document.createElement('div');
    div.className = m.from_user === currentUser.id ? 'message.to' : 'message.from';
    div.textContent = m.message;
    container.appendChild(div);
  });
  container.scrollTop = container.scrollHeight;
}

// Charger messages acheteur vers vendeur
async function loadMessagesSeller(sellerId, productId){
  if(!sellerId || !productId) return;
  const { data, error } = await supabase
    .from('messages')
    .select('*')
    .eq('product_id', productId)
    .or(`from_user.eq.${sellerId},to_user.eq.${sellerId}`)
    .order('created_at', {ascending:true});
  if(error){ console.error(error); return; }

  const container = document.getElementById('messagesList');
  container.innerHTML = '';
  data.forEach(m=>{
    const div = document.createElement('div');
    div.className = m.from_user === currentUser.id ? 'message.to' : 'message.from';
    div.textContent = m.message;
    container.appendChild(div);
  });
  container.scrollTop = container.scrollHeight;
}

// Envoyer message
document.getElementById('sendBtn').onclick = async ()=>{
  const text = document.getElementById('messageInput').value.trim();
  if(!text || !activeProductId) return;

  let toUser = activeBuyerId;
  if(!toUser) return;

  const { error } = await supabase.from('messages').insert([{
    message: text,
    from_user: currentUser.id,
    to_user: toUser,
    product_id: activeProductId
  }]);
  if(error){ alert(error.message); return; }

  document.getElementById('messageInput').value = '';
  if(activeBuyerId && activeProductId) loadMessages();
}

// Rafraîchir messages en temps réel
setInterval(()=>{
  if(activeBuyerId && activeProductId) loadMessages();
  if(activeProductId) loadBuyers(activeProductId);
},2000);

// Initialiser
loadMyProducts();
</script>
</body>
</html>