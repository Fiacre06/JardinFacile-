<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Connexion / Inscription</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Arial;
  background: #f2f7f4;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
}
.login-box {
  background:white;
  padding:30px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  width:320px;
}
h2 { text-align:center; color:#2e8b57; margin-bottom:20px; }
.input-field { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc; font-size:1em; }
.action-btn { width:100%; padding:12px; background:#2e8b57; border:none; color:white; font-weight:bold; border-radius:6px; cursor:pointer; transition:0.2s; margin-top:10px; }
.action-btn:hover { background:#27ae60; }
.switch-link { text-align:center; margin-top:10px; color:#2e8b57; cursor:pointer; font-weight:bold; }
.error { color:red; font-size:0.9em; margin-top:10px; text-align:center; }
</style>
</head>
<body>

<div class="login-box">
  <h2 id="formTitle">Connexion</h2>

  <input type="text" id="username" class="input-field" placeholder="Nom d'utilisateur" style="display:none;">
  <input type="email" id="email" class="input-field" placeholder="Email">
  <input type="password" id="password" class="input-field" placeholder="Mot de passe">

  <select id="role" class="input-field" style="display:none;">
    <option value="acheteur">Acheteur</option>
    <option value="vendeur">Vendeur</option>
  </select>

  <button id="actionBtn" class="action-btn">Se connecter</button>
  <div class="switch-link" id="switchForm">Pas encore inscrit ? Crée un compte</div>
  <div class="error" id="errorMsg"></div>
</div>

<script type="module">
import { supabase } from './supabase.js';

let isLogin = true;

const formTitle = document.getElementById('formTitle');
const actionBtn = document.getElementById('actionBtn');
const switchForm = document.getElementById('switchForm');
const errorMsg = document.getElementById('errorMsg');
const usernameInput = document.getElementById('username');
const roleSelect = document.getElementById('role');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');

// Basculer entre connexion et inscription
switchForm.onclick = () => {
  isLogin = !isLogin;
  if(isLogin){
    formTitle.textContent = "Connexion";
    actionBtn.textContent = "Se connecter";
    switchForm.textContent = "Pas encore inscrit ? Crée un compte";
    usernameInput.style.display = 'none';
    roleSelect.style.display = 'none';
  } else {
    formTitle.textContent = "Inscription";
    actionBtn.textContent = "S'inscrire";
    switchForm.textContent = "Déjà inscrit ? Connecte-toi";
    usernameInput.style.display = 'block';
    roleSelect.style.display = 'block';
  }
  errorMsg.textContent = '';
};

// Gestion connexion / inscription
actionBtn.onclick = async () => {
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  const username = usernameInput.value.trim();
  const role = roleSelect.value;

  if(!email || !password || (!isLogin && (!username || !role))){
    errorMsg.textContent = "Remplis tous les champs";
    return;
  }

  if(isLogin){
    // Connexion
    const { data: { user }, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error){ errorMsg.textContent = "Email ou mot de passe incorrect"; return; }

    // Récupérer profil
    const { data: profile, error: profileError } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', user.id)
      .single();

    if(profileError || !profile){ errorMsg.textContent = "Profil introuvable"; return; }

    window.location.href = profile.role === 'acheteur' ? 'achat.html' : 'vente.html';

  } else {
    // Vérifier doublons
    const { data: existingEmail } = await supabase
      .from('profiles')
      .select('id')
      .eq('email', email)
      .single();
    if(existingEmail){ errorMsg.textContent = "Cet email est déjà utilisé"; return; }

    const { data: existingUsername } = await supabase
      .from('profiles')
      .select('id')
      .eq('username', username)
      .single();
    if(existingUsername){ errorMsg.textContent = "Ce nom d'utilisateur est déjà utilisé"; return; }

    // Inscription Supabase
    const { data, error } = await supabase.auth.signUp({ email, password });
    if(error){ errorMsg.textContent = error.message; return; }

    const userId = data.user.id;

    // Créer le profil dans profiles avec id correct
    const { error: profileError } = await supabase.from('profiles').insert([{
      id: userId,
      username,
      email,
      role
    }]);
    if(profileError){ errorMsg.textContent = profileError.message; return; }

    alert("Inscription réussie !");
    window.location.href = role === 'acheteur' ? 'achat.html' : 'vente.html';
  }
};
</script>

</body>
</html>